---
title: "CART_bleeding analysis"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: no
    theme: united
    highlight: pygments
    df_print: paged
editor_options:
  chunk_output_type: console
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   margin-bottom: 25px;
}

table {
    margin-top: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
```


<style>
div.blue { background-color:#FF6600; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">CAR-T cell and bleeding analysis</span>

</div>
<br>

```{r library, include=FALSE}
library(tidyverse)
library(lubridate)
library(gtsummary)
theme_gtsummary_compact()
theme_set(theme_classic())
```

```{r load}
cart_MM <-
  readxl::read_xlsx(here::here(
    "turabData Cleaning v15 12.1.2022.xlsx"),
    sheet = "Data - Original", na = "NA"
                    ) %>% 
  janitor::clean_names()
```

```{r}
recoded_cart <- cart_MM %>% 
  # Recoding
  mutate(sex = case_when(
    sex == 0             ~ "Male",
    sex == 1             ~ "Female"
  )) %>% 
  mutate(race = case_when(
    race == 1             ~ "NHW",
    race == 2             ~ "NHB",
    race == 3             ~ "Hipanic",
    race == 4             ~ "Asian",
    race == 5             ~ "Others"
  )) %>% 
  mutate(car_t_product = case_when(
    car_t_product == 1             ~ "Abecma",
    car_t_product == 2             ~ "cilta-cel"
  )) %>% 
  mutate(myeloma_sub_type = case_when(
    myeloma_sub_type == 1             ~ "IgG",
    myeloma_sub_type == 2             ~ "IgA",
    myeloma_sub_type == 3             ~ "IgD",
    myeloma_sub_type == 4             ~ "IgM",
    myeloma_sub_type == 5             ~ "lc"
  )) %>% 
  mutate(light_chain_subtype = case_when(
    light_chain_subtype == 1             ~ "kappa",
    light_chain_subtype == 0             ~ "lambda"
  )) %>% 
  mutate(deletion_17p_prior_to_car_t_infusion_1_0 = case_when(
    deletion_17p_prior_to_car_t_infusion_1_0 == 1             ~ "Yes",
    deletion_17p_prior_to_car_t_infusion_1_0 == 0             ~ "No"
  )) %>% 
  mutate(t_4_14_prior_to_car_t_infusion_1_0 = case_when(
    t_4_14_prior_to_car_t_infusion_1_0 == 1             ~ "Yes",
    t_4_14_prior_to_car_t_infusion_1_0 == 0             ~ "No"
  )) %>% 
  mutate(t_14_16_prior_to_car_t_infusion_1_0 = case_when(
    t_14_16_prior_to_car_t_infusion_1_0 == 1             ~ "Yes",
    t_14_16_prior_to_car_t_infusion_1_0 == 0             ~ "No"
  )) %>% 
  mutate(r_iss_at_car_t_infsion = case_when(
    r_iss_at_car_t_infsion == 1             ~ "I",
    r_iss_at_car_t_infsion == 2             ~ "II",
    r_iss_at_car_t_infsion == 3             ~ "III"
  )) %>%
  mutate(prior_auto_sct_1_0 = case_when(
    prior_auto_sct_1_0 == 1             ~ "Yes",
    prior_auto_sct_1_0 == 0             ~ "No"
  )) %>% 
  mutate(amyloid_1_0 = case_when(
    amyloid_1_0 == 1             ~ "Yes",
    amyloid_1_0 == 0             ~ "No"
  )) %>% 
  mutate(plasma_cell_leukemia_1_0 = case_when(
    plasma_cell_leukemia_1_0 == 1             ~ "Yes",
    plasma_cell_leukemia_1_0 == 0             ~ "No"
  )) %>% 
  mutate(extramedullary_disease_1_0 = case_when(
    extramedullary_disease_1_0 == 1             ~ "Yes",
    extramedullary_disease_1_0 == 0             ~ "No"
  )) %>% 
  mutate(disease_status_at_time_of_referral = case_when(
    disease_status_at_time_of_referral == 1             ~ "Refractory/RELAPSED",
    disease_status_at_time_of_referral == 2             ~ "SD",
    disease_status_at_time_of_referral == 3             ~ "PR"
  )) %>%
  mutate(history_of_bleeding_y_n = case_when(
    history_of_bleeding_y_n == 1             ~ "Yes",
    history_of_bleeding_y_n == 0             ~ "No"
  )) %>% 
  mutate(bleeding_event_type = case_when(
    bleeding_event_type == 1             ~ "gross hematuria",
    bleeding_event_type == 2             ~ "SDH",
    bleeding_event_type == 3             ~ "SSI",
    bleeding_event_type == 4             ~ "MSK bleed",
    bleeding_event_type == 5             ~ "GI bleed",
    bleeding_event_type == 6             ~ "Hemptysis"
  )) %>%
  mutate(history_of_clotting_y_n = case_when(
    history_of_clotting_y_n == 1             ~ "Yes",
    history_of_clotting_y_n == 0             ~ "No"
  )) %>% 
  mutate(clotting_event_type = case_when(
    clotting_event_type == 1             ~ "DVT",
    clotting_event_type == 2             ~ "line asso. DVT",
    clotting_event_type == 3             ~ "Thrombotic stroke",
    clotting_event_type == 4             ~ "Portal vein thrombosis",
    clotting_event_type == 5             ~ "Spl. V thrombosis",
    clotting_event_type == 6             ~ "sigmoid sinus thrombus"
  )) %>%
  mutate(neurological_comorbidit_y_pre_car_t_1_0 = case_when(
    neurological_comorbidit_y_pre_car_t_1_0 == 1             ~ "Yes",
    neurological_comorbidit_y_pre_car_t_1_0 == 0             ~ "No"
  )) %>% 
  mutate(vascular_comorbidity_dvt_stroke_ht0_cad_y_0 = case_when(
    vascular_comorbidity_dvt_stroke_ht0_cad_y_0 == 1             ~ "Yes",
    vascular_comorbidity_dvt_stroke_ht0_cad_y_0 == 0             ~ "No"
  )) %>% 
  mutate(anticoagulation_preceding_car_t_y_n = case_when(
    anticoagulation_preceding_car_t_y_n == 1             ~ "Yes",
    anticoagulation_preceding_car_t_y_n == 0             ~ "No"
  )) %>% 
  mutate(event_resulting_in_cessation_of_ac_therapy_y_n = case_when(
    event_resulting_in_cessation_of_ac_therapy_y_n == 1             ~ "Yes",
    event_resulting_in_cessation_of_ac_therapy_y_n == 0             ~ "No"
  )) %>% 
  mutate(bridging_therapy_1_0 = case_when(
    bridging_therapy_1_0 == 1             ~ "Yes",
    bridging_therapy_1_0 == 0             ~ "No"
  )) %>% 
  mutate(bleeding_events_during_or_post_cart_y_n = case_when(
    bleeding_events_during_or_post_cart_y_n == 1             ~ "Yes",
    bleeding_events_during_or_post_cart_y_n == 0             ~ "No"
  )) %>% 
  mutate(bleeding_y_n = case_when(
    bleeding_y_n == 1             ~ "Yes",
    bleeding_y_n == 0             ~ "No"
  ), bleeding_y_n = factor(bleeding_y_n, levels = c("No", "Yes"))) %>% 
  mutate(thrombosis_events_post_car_t_y_n = case_when(
    thrombosis_events_post_car_t_y_n == 1             ~ "Yes",
    thrombosis_events_post_car_t_y_n == 0             ~ "No"
  ), thrombosis_events_post_car_t_y_n = factor(thrombosis_events_post_car_t_y_n, levels = c("No", "Yes"))) %>% 
  # mutate(who_grade_of_bleeding_259 = case_when(
  #   who_grade_of_bleeding_259 == 1             ~ "Petechia, purpura, oropharyngeal bleed, epistaxis <1 hr, vaginal bleed <2 pads/dat",
  #   who_grade_of_bleeding_259 == 2             ~ "Echymosis >10 cms, Hematoma, retinal hemorrhage without vision impairment,hematuria, hemotysis,melena, joint bleed",
  #   who_grade_of_bleeding_259 == 3             ~ "bleeding req. BT, bleeding with mod hD unstability",
  #   who_grade_of_bleeding_259 == 4             ~ "severe HD unstability, fata bleeding, CNS bleeding"
  # )) %>% 
  # mutate(isth_dic_score_5_y_n_at_time_of_event = case_when(
  #   isth_dic_score_5_y_n_at_time_of_event == 1             ~ "Yes",
  #   isth_dic_score_5_y_n_at_time_of_event == 0             ~ "No"
  # )) %>% 
  # mutate(exposure_to_direct_hepatotoxic_drugs_y_n_276 = case_when(
  #   exposure_to_direct_hepatotoxic_drugs_y_n_276 == 1             ~ "Yes",
  #   exposure_to_direct_hepatotoxic_drugs_y_n_276 == 2             ~ "No"
  # )) %>% 
  # mutate(treatment_for_bleeding_event_y_n_277 = case_when(
  #   treatment_for_bleeding_event_y_n_277 == 1             ~ "Yes",
  #   treatment_for_bleeding_event_y_n_277 == 2             ~ "No"
  # )) %>% 
  # mutate(ffp_transfusion_y_n_278 = case_when(
  #   ffp_transfusion_y_n_278 == 1             ~ "Yes",
  #   ffp_transfusion_y_n_278 == 2             ~ "No"
  # )) %>% 
  # mutate(platelet_transfusion_y_n_280 = case_when(
  #   platelet_transfusion_y_n_280 == 1             ~ "Yes",
  #   platelet_transfusion_y_n_280 == 2             ~ "No"
  # )) %>% 
  # mutate(cryoprecipitate_transfusion_y_n_282 = case_when(
  #   cryoprecipitate_transfusion_y_n_282 == 1             ~ "Yes",
  #   cryoprecipitate_transfusion_y_n_282 == 2             ~ "No"
  # )) %>% 
  mutate(another_site_of_bleeding_if_any = case_when( ############################ Green
    another_site_of_bleeding_if_any == 1             ~ "Yes",
    another_site_of_bleeding_if_any == 2             ~ "No"
  )) %>% 
  
  
  
  
  
  mutate(x3rd_site_of_bleed_y_n = case_when( ################################ PINK
    x3rd_site_of_bleed_y_n == 1             ~ "Yes",
    x3rd_site_of_bleed_y_n == 2             ~ "No"
  )) %>% 
  # mutate(treatment_for_thrombosis_y_n_365 = case_when( ######################### ORANGE
  #   treatment_for_thrombosis_y_n_365 == 1             ~ "Yes",
  #   treatment_for_thrombosis_y_n_365 == 0             ~ "No"
  # )) %>% 
  mutate(tocilizumab_yes_no = case_when(
    tocilizumab_yes_no == 1             ~ "Yes",
    tocilizumab_yes_no == 2             ~ "No"
  )) %>% 
  mutate(steroid_use_yes_no = case_when(
    steroid_use_yes_no == 1             ~ "Yes",
    steroid_use_yes_no == 2             ~ "No"
  )) %>% 
  mutate(anakinra_yes_no = case_when(
    anakinra_yes_no == 1             ~ "Yes",
    anakinra_yes_no == 2             ~ "No"
  )) %>% 
  mutate(any_other_crs_icans_therapy_y_n = case_when(
    any_other_crs_icans_therapy_y_n == 1             ~ "Yes",
    any_other_crs_icans_therapy_y_n == 2             ~ "No"
  )) %>% 
  
  mutate(pod_y_n = case_when(
    pod_y_n == 1             ~ "Yes",
    pod_y_n == 2             ~ "No"
  )) %>% 
  mutate(death_from_clotting_or_bleeding_with_in_90_days_of_car_t = case_when(
    death_from_clotting_or_bleeding_with_in_90_days_of_car_t == 1             ~ "Yes",
    death_from_clotting_or_bleeding_with_in_90_days_of_car_t == 2             ~ "No"
  )) %>%
  # New variable
  # cytogenetics
  mutate(any_cytogenetics = case_when(
    deletion_17p_prior_to_car_t_infusion_1_0 == "Yes" | 
      t_4_14_prior_to_car_t_infusion_1_0 == "Yes" | 
      t_14_16_prior_to_car_t_infusion_1_0 == "Yes"   ~ "Yes",
    deletion_17p_prior_to_car_t_infusion_1_0 == "No" &
      t_4_14_prior_to_car_t_infusion_1_0 == "No" &
      t_14_16_prior_to_car_t_infusion_1_0 == "No"    ~ "No"
  )) %>% 
  # CRS and ICANS
  mutate(any_CRS = case_when(
    highest_gr_crs_grade_0_5 > 0       ~ "Yes",
    TRUE                               ~ "No"
  )) %>% 
  mutate(any_ICANS = case_when(
    highest_gr_icans_recorded_relative_to_infusion > 0       ~ "Yes",
    TRUE                                                     ~ "No"
  )) %>% 
  mutate(CRS_cat = case_when(
    highest_gr_crs_grade_0_5 == 0 |
      highest_gr_crs_grade_0_5 == 1              ~ "0-1",
    highest_gr_crs_grade_0_5 >= 2                ~ "≥2"
  )) %>% 
  mutate(ICANS_cat = case_when(
    highest_gr_icans_recorded_relative_to_infusion == 0 |
      highest_gr_icans_recorded_relative_to_infusion == 1              ~ "0-1",
    highest_gr_icans_recorded_relative_to_infusion >= 2                ~ "≥2"
  ), ICANS_cat = factor(ICANS_cat, levels = c("0-1", "≥2"))) %>% 
  # Verified ORR
  mutate(orr_response_d_30_verified = case_when(
    str_detect(day_30_response_s_cr_cr_vgpr_pr_nr, "CR")   ~ "ORR",
    str_detect(day_30_response_s_cr_cr_vgpr_pr_nr, "PR")   ~ "ORR",
    is.na(day_30_response_s_cr_cr_vgpr_pr_nr)              ~ NA_character_,
    TRUE                                                                        ~ "PD/SD/MR"
  )) %>% 
  mutate(orr_response_d_90_verified = case_when(
    str_detect(day_90_response_s_cr_cr_vgpr_pr, "CR")   ~ "ORR",
    str_detect(day_90_response_s_cr_cr_vgpr_pr, "PR")   ~ "ORR",
    is.na(day_90_response_s_cr_cr_vgpr_pr)              ~ NA_character_,
    TRUE                                                                        ~ "PD/SD/MR"
  )) %>% 
  # Remove the < and > sign
  mutate(wo_sign = as.numeric(str_remove(ferritin_day_7, ">"))) %>% 
  mutate(ferritin_day_7 = case_when(
    str_detect(ferritin_day_7, ">")                 ~ max(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(ferritin_day_7)
    )) %>% 
  mutate(wo_sign = as.numeric(str_remove(crp_pre_leukapheresis, "<"))) %>% 
  mutate(crp_pre_leukapheresis = case_when(
    str_detect(crp_pre_leukapheresis, "<")          ~ min(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(crp_pre_leukapheresis)
    )) %>% 
  mutate(wo_sign = as.numeric(str_remove(crp_day_10, "<"))) %>% 
  mutate(crp_day_10 = case_when(
    str_detect(crp_day_10, "<")                 ~ min(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(crp_day_10)
    )) %>% 
  mutate(wo_sign = as.numeric(str_remove(crp_day_14, "<"))) %>% 
  mutate(crp_day_14 = case_when(
    str_detect(crp_day_14, "<")                 ~ min(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(crp_day_14)
    )) %>% 
  mutate(wo_sign = as.numeric(str_remove(crp_day_21, "<"))) %>% 
  mutate(crp_day_21 = case_when(
    str_detect(crp_day_21, "<")                 ~ min(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(crp_day_21)
    )) %>% 
  mutate(wo_sign = as.numeric(str_remove(crp_day_30, "<"))) %>% 
  mutate(crp_day_30 = case_when(
    str_detect(crp_day_30, "<")                 ~ min(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(crp_day_30)
    )) %>% 
  mutate(wo_sign = as.numeric(str_remove(crp_day_60, "<"))) %>% 
  mutate(crp_day_60 = case_when(
    str_detect(crp_day_60, "<")                 ~ min(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(crp_day_60)
    )) %>% 
  mutate(wo_sign = as.numeric(str_remove(crp_day_90, "<"))) %>% 
  mutate(crp_day_90 = case_when(
    str_detect(crp_day_90, "<")                 ~ min(wo_sign, na.rm = TRUE),
    TRUE                                            ~ as.numeric(crp_day_90)
    )) %>% 
  mutate(marrow_cd138_baseline_cat = case_when(
    marrow_cd138_baseline_percent < 50           ~ "<50%",
    marrow_cd138_baseline_percent >= 50           ~ "≥50%"
  )) %>% 
  # mutate(across(.cols = c(starts_with("ldh_day")), ~na_if(., ".")))
  mutate(across(c("days_to_death_from_most_recent_cart_infusion", "ferritin_day_14",
                  starts_with("ldh_day")), ~as.numeric(.))) %>% 
  # Refractory status
  mutate(refractory_disease_status = str_to_sentence(refractory_disease_status)) %>% 
  mutate(penta_refractory = case_when(
    refractory_disease_status == "Penta"      ~ "Yes",
    TRUE                                      ~ "No"
  )) %>% 
  mutate(double_refractory = case_when(
    refractory_disease_status == "Double"     ~ "Yes",
    TRUE                                      ~ "No"
  )) %>% 
  mutate(triple_refractory = case_when(
    refractory_disease_status == "Triple"     ~ "Yes",
    TRUE                                      ~ "No"
  )) %>% 
  mutate(date_of_progression_documentation_if_any = case_when(
    str_detect(date_of_progression_documentation_if_any,
               "None|not")                                    ~ NA_character_,
    TRUE                                                      ~ date_of_progression_documentation_if_any
  ), 
  date_of_progression_documentation_if_any = 
    as.Date(as.numeric(date_of_progression_documentation_if_any),
                                             origin = "1899-12-30")
  ) %>% 
  mutate(evaluable_90days = case_when(
    date_of_death <= (date_of_car_t_infusion_69 + days(95))   ~ "PD=death",
    Sys.Date() <= (date_of_car_t_infusion_69 + days(95))      ~ "not evaluable",

    is.na(orr_response_d_90_verified) &
      Sys.Date() > (date_of_car_t_infusion_69 + days(95))     ~ "missing"
  )) %>%
  mutate(orr_response_d_90_verified = case_when(
    !is.na(orr_response_d_90_verified)                        ~ orr_response_d_90_verified,
    evaluable_90days == "PD=death"                            ~ "PD/SD/MR",
    evaluable_90days == "not evaluable"                       ~ NA_character_,
    orr_response_d_30_verified == "PD/SD/MR"                  ~ "PD/SD/MR",
    !is.na(date_of_progression_documentation_if_any)          ~ "PD/SD/MR",
    is.na(orr_response_d_90_verified)                         ~ "PD/SD/MR"
  )) %>%
  mutate(time30 = date_of_car_t_infusion_69 + days(95))

a <- recoded_cart %>%
  select(pt, mrn, date_of_car_t_infusion_69, evaluable_90days,
         date_of_death, date_of_progression_documentation_if_any,
         orr_response_d_90_verified)
```

# Table 1. summarizing the baseline characteristics of the patients reviewed in the study
```{r}
recoded_cart %>% 
  select(
    age, sex,
    plt_apheresis,
    ecog_at_screening,
    r_iss_at_car_t_infsion,
    extramedullary_disease_1_0,
    any_cytogenetics,
    bridging_therapy_1_0,
    prior_auto_sct_1_0,
    refractory_disease_status,
    penta_refractory, double_refractory, triple_refractory,
    ldh_at_pre_leukapheresis,
    b2_m_at_pre_leukapheresis,
    marrow_cd138_baseline_percent,
    marrow_cd138_baseline_cat,
    any_CRS, 
    any_ICANS,
    
    # orr_response_at_d_30, orr_response_at_d_90,
    orr_response_d_30_verified, 
    bleeding_y_n
  ) %>% 
  tbl_summary(by= bleeding_y_n,
              type = list(c(extramedullary_disease_1_0,
                            any_cytogenetics, bridging_therapy_1_0,
                            prior_auto_sct_1_0,
                            penta_refractory, double_refractory, triple_refractory,
                            any_CRS, any_ICANS)
                          ~ "categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Bleeding event**")

recoded_cart %>% 
  # filter(evaluable_90days != "not evaluable" | is.na(evaluable_90days)) %>% 
  select(
    orr_response_d_90_verified,
    bleeding_y_n
  ) %>% 
  tbl_summary(by= bleeding_y_n,
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Bleeding event**")

recoded_cart %>% 
  select(
    history_of_bleeding_y_n,
    history_of_clotting_y_n,
    neurological_comorbidit_y_pre_car_t_1_0,
    vascular_comorbidity_dvt_stroke_ht0_cad_y_0,
    anticoagulation_preceding_car_t_y_n,
    bleeding_y_n
  ) %>% 
  tbl_summary(by= bleeding_y_n,
              type = list(c(history_of_bleeding_y_n, history_of_clotting_y_n,
                            neurological_comorbidit_y_pre_car_t_1_0,
                            vascular_comorbidity_dvt_stroke_ht0_cad_y_0,
                            anticoagulation_preceding_car_t_y_n)
                          ~ "categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Bleeding event**")

```


```{r}
recoded_cart %>% 
  select(
    age, sex,
    plt_apheresis,
    ecog_at_screening,
    r_iss_at_car_t_infsion,
    extramedullary_disease_1_0,
    any_cytogenetics,
    bridging_therapy_1_0,
    prior_auto_sct_1_0,
    refractory_disease_status,
    penta_refractory, double_refractory, triple_refractory,
    ldh_at_pre_leukapheresis,
    b2_m_at_pre_leukapheresis,
    marrow_cd138_baseline_percent,
    marrow_cd138_baseline_cat,
    any_CRS, 
    any_ICANS,
    
    # orr_response_at_d_30, orr_response_at_d_90,
    orr_response_d_30_verified, 
    thrombosis_events_post_car_t_y_n
  ) %>% 
  tbl_summary(by= thrombosis_events_post_car_t_y_n,
              type = list(c(extramedullary_disease_1_0,
                            any_cytogenetics, bridging_therapy_1_0,
                            prior_auto_sct_1_0,
                            penta_refractory, double_refractory, triple_refractory,
                            any_CRS, any_ICANS)
                          ~ "categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Thrombosis event**")

recoded_cart %>% 
  # filter(evaluable_90days != "not evaluable" | is.na(evaluable_90days)) %>% 
  select(
    orr_response_d_90_verified,
    thrombosis_events_post_car_t_y_n
  ) %>% 
  tbl_summary(by= thrombosis_events_post_car_t_y_n,
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Thrombosis event**")

recoded_cart %>% 
  select(
    history_of_bleeding_y_n,
    history_of_clotting_y_n,
    neurological_comorbidit_y_pre_car_t_1_0,
    vascular_comorbidity_dvt_stroke_ht0_cad_y_0,
    anticoagulation_preceding_car_t_y_n,
    thrombosis_events_post_car_t_y_n
  ) %>% 
  tbl_summary(by= thrombosis_events_post_car_t_y_n,
              type = list(c(history_of_bleeding_y_n, history_of_clotting_y_n,
                            neurological_comorbidit_y_pre_car_t_1_0,
                            vascular_comorbidity_dvt_stroke_ht0_cad_y_0,
                            anticoagulation_preceding_car_t_y_n)
                          ~ "categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Thrombosis event**")
```

# Table 2: Types and grades of major CAR-T related toxicities documented among study participants 
```{r}
recoded_cart %>% 
  select(
    highest_gr_crs_grade_0_5, 
    highest_gr_icans_recorded_relative_to_infusion,
    CRS_cat, ICANS_cat,
    bleeding_y_n
  ) %>% 
  tbl_summary(by= bleeding_y_n,
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Bleeding event**")

recoded_cart %>% 
  select(
    highest_gr_crs_grade_0_5, 
    highest_gr_icans_recorded_relative_to_infusion,
    CRS_cat, ICANS_cat,
    thrombosis_events_post_car_t_y_n
  ) %>% 
  tbl_summary(by= thrombosis_events_post_car_t_y_n,
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Thrombosis event**")
```


# Table 3. showing laboratory findings of patients who received CAR-T cell therapy with frequency of abnormal lab values, and median nadir or peak values as listed in patients with bleeding and thrombosis.
```{r}
recoded_cart %>% 
  select(
    pt_pretreatment,
    aptt_pretreatment,
    inr_pretreatment,
    lower_platelet_nadir_x_1000_u_l,
    ferritin_at_pre_leukapheresis,
    ferritin_peak_ng_ml,
    crp_pre_leukapheresis,
    crp_peak_ng_ml,
    
    bleeding_y_n
  ) %>% 
  tbl_summary(by= bleeding_y_n,
              type = list(c(inr_pretreatment)
                          ~ "continuous"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Bleeding event**")

recoded_cart %>% 
  select(
    pt_pretreatment,
    aptt_pretreatment,
    inr_pretreatment,
    lower_platelet_nadir_x_1000_u_l,
    ferritin_at_pre_leukapheresis,
    ferritin_peak_ng_ml,
    crp_pre_leukapheresis,
    crp_peak_ng_ml,
    
    thrombosis_events_post_car_t_y_n
  ) %>% 
  tbl_summary(by= thrombosis_events_post_car_t_y_n,
              type = list(c(inr_pretreatment)
                          ~ "continuous"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_p() %>% bold_p(t= .05) %>% 
  add_overall() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Thrombosis event**")
```


# Figures: 
## Fig 1. Cumulative incidence
```{r}
library(tidycmprsk)
library(ggsurvfit)

recoded_cart2 <- recoded_cart %>% 
  mutate(event_type = case_when(
    bleeding_y_n == "Yes" &
      thrombosis_events_post_car_t_y_n == "Yes"     ~ "Bleeding+Thrombosis",
    bleeding_y_n == "Yes"       ~ "Bleeding",
    thrombosis_events_post_car_t_y_n == "Yes"     ~ "Thrombosis",
    TRUE   ~ "None"
  )) %>% 
  mutate(event = case_when(
    bleeding_y_n == "Yes" |
      thrombosis_events_post_car_t_y_n == "Yes"     ~ "Yes",
    TRUE ~ "No"
  )) %>% 
  mutate(event_type =
           factor(event_type, levels= c("None","Bleeding","Thrombosis"))) %>%
  mutate(event_type1 = case_when(
    event_type == "None"            ~ 0,
    event_type == "Bleeding"            ~ 1,
    event_type == "Thrombosis"            ~ 1
  )) %>% 
  mutate(event_type2 = case_when(
    event_type == "Bleeding"       ~ "Bleeding",
    event_type == "Thrombosis"     ~ "Thrombosis",
    TRUE   ~ NA_character_
  )) %>% 
  mutate(date_of_event = coalesce(
    no_of_days_after_car_t_bleeding_event, 
    onset_of_first_thrombotic_event_how_many_days_after_car_t_cell_rx, days_to_death_from_most_recent_cart_infusion),
    date_of_event = case_when(
      is.na(date_of_event)   ~ 300,
      TRUE     ~ date_of_event))

cum_inc <- cuminc(Surv(date_of_event, event_type) ~ 1, data = recoded_cart2) %>% 
  ggcuminc(outcome = c("Bleeding", "Thrombosis"), 
           geom_step(linewidth=10)) +
  ylim(c(0, 1)) + 
  labs(
    x = "Days"
  )+
  add_risktable()
cum_inc

cuminc(Surv(date_of_event, event_type) ~ 1, data = recoded_cart2) %>% 
  ggcuminc(outcome = c("Bleeding", "Thrombosis"), 
           geom_step(linewidth=10)) +
  ylim(c(0, 0.25)) +
  labs(
    x = "Days"
  )+
  add_risktable()

library(survminer)
library(survival)

# fit <- survfit2( Surv(date_of_event, event_type) ~ 1, 
#                 data = recoded_cart2 )
# 
# ggsurvplot(fit, data = recoded_cart2,
#   fun = "cumhaz")

survfit2( Surv(date_of_event, event_type) ~ 1,
                data = recoded_cart2 ) %>%
  tidy_survfit() %>%
  ggplot(aes(x=time, y=estimate, color= outcome))+
  geom_step() +
  scale_color_manual(values=c("red", "blue"))+
  labs(
    x= "Days", y= "Cumulative incidence"
  )+
  ylim(c(0, 0.25))+
  theme(legend.position='bottom',
        legend.title = element_blank())

survfit2( Surv(date_of_event, event_type) ~ 1,
                data = recoded_cart2 ) %>%
  tidy_survfit() %>%
  ggplot(aes(x=time, y=estimate, color= outcome))+
  geom_step() +
  scale_color_manual(values=c("red", "blue"))+
  labs(
    x= "Days", y= "Cumulative incidence"
  )+
  ylim(c(0, 0.25))+
  theme_minimal()+
  theme(legend.position='bottom',
        legend.title = element_blank())

# Table
recoded_cart %>% 
  select(
    bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis
  ) %>% 
  tbl_summary(
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              missing = "no") %>% 
  bold_labels() %>% 
  add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

# 
# 
# fit<- survfit(Surv(time = recoded_cart2$date_of_event,
#              event = recoded_cart2$event_type1) ~ 
#           1,
#         data =  recoded_cart2)
# 
# # Survival tables
# #:::::::::::::::::::::::::::::::::::::::::::::::
# tables <- ggsurvtable(fit, data = recoded_cart2, color = "strata",
#   y.text = FALSE)
# 
# # Risk table
# tables$risk.table
# ggsurvtable(fit, 
#             survtable = "risk.table",
#             risk.table.type = "nrisk_cumevents",
#             data = recoded_cart2, color = "strata",
#   y.text = FALSE)
# 
# survfit(Surv(time = recoded_cart2$date_of_event,
#              event = recoded_cart2$event_type1) ~ 
#           1,
#         data =  recoded_cart2)
# myplot <- ggsurvplot(
#   survfit(Surv(time = recoded_cart2$date_of_event,
#              event = recoded_cart2$event_type1) ~ 
#           event_type2,
#         data =  recoded_cart2), 
#   
#   data= recoded_cart2,
#         fun = "event",
#   legend.title = "",
#   legend.labs = c("Bleeding", "Thrombosis"),
#   palette = c("red", "blue"),
#   risk.table = TRUE,
#   tables.col = "strata",
#   # break.time.by = 3,
#   cumevents = TRUE
#         )
# myplot
# myplot$table
# myplot$cumevents
#myplot$table <- myplot$table + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))




# event_fit <-
#  cmprsk::cuminc(
#     ftime = cart_MM$no_of_days_after_car_t_bleeding_event,
#     fstatus = cart_MM$bleeding_y_n,
#     group = cart_MM$bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis)
# 
# ggcompetingrisks(event_fit, multiple_panels = FALSE) +
#   scale_linetype_manual(name="Infection type", values=1:4,#labels=c("High","Low")
#   )
# 
# recoded_cart1 <- recoded_cart %>% 
#   # filter(!is.na(no_of_days_after_car_t_bleeding_event)) %>% 
#   mutate(bleeding_y_n = case_when(
#     bleeding_y_n == "Yes"             ~ 1,
#     bleeding_y_n == "No"              ~ 0
#   )) %>%
#   mutate(bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis = 
#            as.factor(bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis))  %>%
#   mutate(bleeding_y_n = 
#            as.factor(bleeding_y_n))#%>% 
#   # mutate(no_of_days_after_car_t_bleeding_event = case_when(
#   #   is.na(no_of_days_after_car_t_bleeding_event)   ~ 100,
#   #   TRUE     ~ no_of_days_after_car_t_bleeding_event
#   # ))
# 
# 
# event_fit1 <-
#   cmprsk::cuminc(
#     ftime = recoded_cart1$no_of_days_after_car_t_bleeding_event,
#     fstatus = recoded_cart1$bleeding_y_n,
#     group = recoded_cart1$bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis)
# 
# ggcompetingrisks(event_fit1, multiple_panels = FALSE) +
#   scale_linetype_manual(name="Bleeding type", values=1:4,#labels=c("High","Low")
#   )
# 
# event_fit <-
#  cuminc(
#     ftime = recoded_cart1$no_of_days_after_car_t_bleeding_event,
#     fstatus = recoded_cart1$bleeding_y_n,
#     group = recoded_cart1$bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis)
# 
# ggcompetingrisks(event_fit, multiple_panels = FALSE) +
#   scale_linetype_manual(name="Infection type", values=1:4,#labels=c("High","Low")
#   )#+
#   # guides(col="none")
# 
# recoded_cart1 <- recoded_cart %>% 
#   # filter(!is.na(no_of_days_after_car_t_bleeding_event)) %>% 
#   mutate(bleeding_y_n = case_when(
#     bleeding_y_n == "Yes"             ~ 1,
#     bleeding_y_n == "No"              ~ 0
#   )) %>%
#   mutate(bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis = 
#            as.factor(bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis))  %>%
#   mutate(bleeding_y_n = 
#            as.factor(bleeding_y_n)) %>% 
#   mutate(no_of_days_after_car_t_bleeding_event = case_when(
#     is.na(no_of_days_after_car_t_bleeding_event)   ~ 500,
#     TRUE     ~ no_of_days_after_car_t_bleeding_event
#   ))
# 
# tidycmprsk::cuminc(
#   Surv(time =  no_of_days_after_car_t_bleeding_event, event =  bleeding_y_n) ~ bleeding_events_type_gib_hematuria_sdh_ich_ssi_hemoptysis, recoded_cart1) %>%
#   ggcuminc(outcome = 1) #+
#   # add_confidence_interval() +
#   # add_risktable()
# 
# 
#   
#   library(tidycmprsk)
# 
# cuminc(Surv(ttdeath, death_cr) ~ trt, trial) %>%
#   ggcuminc(outcome = "death from cancer") +
#   add_confidence_interval() +
#   add_risktable()
# 
# 
# cuminc(Surv(ttdeath, death_cr) ~ trt, trial) %>%
#   ggcuminc(outcome = c("death from cancer", "death other causes")) +
#   add_risktable()
# 
# 
# # using the survival multi-state model
# survfit2(Surv(ttdeath, death_cr) ~ trt, trial) %>%
#   ggcuminc(outcome = "death from cancer") +
#   add_confidence_interval() +
#   add_risktable()
# 
# 
# survfit2(Surv(ttdeath, death_cr) ~ trt, trial) %>%
#   ggcuminc(outcome = c("death from cancer", "death other causes")) +
#   add_risktable()
# 
# 
#   
#   
# cart$ICANS_fup[cart$ICANS_fup==30] <- 7
# ICANS <- 
#  cuminc(
#     ftime = cart$ICANS_fup, 
#     fstatus = cart$ICANS_any2, 
#     group = cart$tumor_burden)
# ggcompetingrisks(ICANS, multiple_panels = FALSE) + scale_linetype_manual(name="Tumor burden",values=1:2,labels=c("High","Low"))+
# guides(col="none")
```

## Figure 2.
```{r, fig.height=16, fig.width=16}
recoded_cart %>% 
  select(pt, bleeding_y_n,
         plt_apheresis, starts_with("plt_day"),
         starts_with("mono"), 
         ferritin_at_pre_leukapheresis, starts_with("ferritin_day"), 
         crp_pre_leukapheresis, starts_with("crp_day"), 
         # ldh_at_pre_leukapheresis, starts_with("ldh_day"), 
         aptt_pretreatment, starts_with("ptt_s_day"), 
         pt_pretreatment, pt_s_day_0, starts_with("pt_day")#, 
         # inr_pretreatment
         ) %>% 
  pivot_longer(cols = -c(pt, bleeding_y_n)) %>% 
  mutate(name = str_remove(name, "_k_ul|_k_u_l"),
         day = case_when(
           str_detect(name, "apheresis")         ~ -28,
           str_detect(name, "pretreatment")         ~ -28,
           str_detect(name, "day")               ~ as.numeric((str_match(name, "([0-9]+)"))[,2])
         ), 
         day = case_when(
           day == 6     ~ -6,
           TRUE               ~ day
         ),
         type = str_match(name, "^([a-z]*)_")[,2],
         type = case_when(
           type == "aptt"     ~ "ptt",
           type == "monos"     ~ "mono",
           TRUE               ~ type
         )) %>% 
  group_by(bleeding_y_n, type, day) %>% 
  summarise(lab_median = median(value, na.rm= TRUE),
            lab_sd = sd(value, na.rm= TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = day, y = lab_median, color= bleeding_y_n)) + 
  geom_line() + 
  geom_errorbar(aes(ymin = lab_median - lab_sd, ymax = lab_median + lab_sd), width = 5)+
  xlab("Days relative to infusion") +
  ylab("Median - SD") +
  theme_classic(base_size = 14)+
  scale_color_discrete(name="Bleeding")+
  scale_x_continuous(
    breaks = c(-28, -6, 0, 7, 10, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-6", "0", "7", "10", "14", "21", "30", "60", "90")
  )+
  theme(legend.position= "bottom")+
  facet_wrap(type ~ ., scales = "free", ncol = 2)

recoded_cart %>% 
  select(pt, thrombosis_events_post_car_t_y_n,
         plt_apheresis, starts_with("plt_day"),
         starts_with("mono"), 
         ferritin_at_pre_leukapheresis, starts_with("ferritin_day"), 
         crp_pre_leukapheresis, starts_with("crp_day"), 
         # ldh_at_pre_leukapheresis, starts_with("ldh_day"), 
         aptt_pretreatment, starts_with("ptt_s_day"), 
         pt_pretreatment, pt_s_day_0, starts_with("pt_day")#, 
         # inr_pretreatment
         ) %>% 
  pivot_longer(cols = -c(pt, thrombosis_events_post_car_t_y_n)) %>% 
  mutate(name = str_remove(name, "_k_ul|_k_u_l"),
         day = case_when(
           str_detect(name, "apheresis")         ~ -28,
           str_detect(name, "pretreatment")         ~ -28,
           str_detect(name, "day")               ~ as.numeric((str_match(name, "([0-9]+)"))[,2])
         ), 
         day = case_when(
           day == 6     ~ -6,
           TRUE               ~ day
         ),
         type = str_match(name, "^([a-z]*)_")[,2],
         type = case_when(
           type == "aptt"     ~ "ptt",
           type == "monos"     ~ "mono",
           TRUE               ~ type
         )) %>% 
  group_by(thrombosis_events_post_car_t_y_n, type, day) %>% 
  summarise(lab_median = median(value, na.rm= TRUE),
            lab_sd = sd(value, na.rm= TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = day, y = lab_median, color= thrombosis_events_post_car_t_y_n)) + 
  geom_line() + 
  geom_errorbar(aes(ymin = lab_median - lab_sd, ymax = lab_median + lab_sd), width = 5)+
  xlab("Days relative to infusion") +
  ylab("Median - SD") +
  theme_classic(base_size = 14)+
  scale_color_discrete(name="Thrombosis")+
  scale_x_continuous(
    breaks = c(-28, -6, 0, 7, 10, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-6", "0", "7", "10", "14", "21", "30", "60", "90")
  )+
  theme(legend.position= "bottom")+
  facet_wrap(type ~ ., scales = "free", ncol = 2)

recoded_cart %>% 
  select(pt, ICANS_cat,
         plt_apheresis, starts_with("plt_day"),
         starts_with("mono"), 
         ferritin_at_pre_leukapheresis, starts_with("ferritin_day"), 
         crp_pre_leukapheresis, starts_with("crp_day"), 
         # ldh_at_pre_leukapheresis, starts_with("ldh_day"), 
         aptt_pretreatment, starts_with("ptt_s_day"), 
         pt_pretreatment, pt_s_day_0, starts_with("pt_day")#, 
         # inr_pretreatment
         ) %>% 
  pivot_longer(cols = -c(pt, ICANS_cat)) %>% 
  mutate(name = str_remove(name, "_k_ul|_k_u_l"),
         day = case_when(
           str_detect(name, "apheresis")         ~ -28,
           str_detect(name, "pretreatment")         ~ -28,
           str_detect(name, "day")               ~ as.numeric((str_match(name, "([0-9]+)"))[,2])
         ), 
         day = case_when(
           day == 6     ~ -6,
           TRUE               ~ day
         ),
         type = str_match(name, "^([a-z]*)_")[,2],
         type = case_when(
           type == "aptt"     ~ "ptt",
           type == "monos"     ~ "mono",
           TRUE               ~ type
         )) %>% 
  group_by(ICANS_cat, type, day) %>% 
  summarise(lab_median = median(value, na.rm= TRUE),
            lab_sd = sd(value, na.rm= TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = day, y = lab_median, color= ICANS_cat)) + 
  geom_line() + 
  geom_errorbar(aes(ymin = lab_median - lab_sd, ymax = lab_median + lab_sd), width = 5)+
  xlab("Days relative to infusion") +
  ylab("Median - SD") +
  theme_classic(base_size = 14)+
  scale_color_discrete(name="ICANS")+
  scale_x_continuous(
    breaks = c(-28, -6, 0, 7, 10, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-6", "0", "7", "10", "14", "21", "30", "60", "90")
  )+
  theme(legend.position= "bottom")+
  facet_wrap(type ~ ., scales = "free", ncol = 2)
```


# MVA
```{r prep MVA}
# recoded_cart3 <- recoded_cart %>% 
#   mutate(bleeding_y_n = case_when(
#     bleeding_y_n == "No"    ~ 0,
#     bleeding_y_n == "Yes"   ~ 1
#   )) %>% 
#   mutate(r_iss_at_car_t_infsion = case_when(
#     r_iss_at_car_t_infsion == "I" |
#     r_iss_at_car_t_infsion == "II"           ~ "I-II",
#     TRUE                 ~ r_iss_at_car_t_infsion
#   ))
```


```{r glm}
# glm(bleeding_y_n ~ plt_apheresis + r_iss_at_car_t_infsion + ldh_at_pre_leukapheresis + history_of_bleeding_y_n,
#     data = recoded_cart3,
#     family = "binomial") %>%
#   tbl_regression(exponentiate = TRUE, 
#                  intercept = TRUE) %>%
#   add_nevent(location = "level") %>% add_n(location = "level") %>%
#   modify_spanning_header(everything() ~ "**bleeding_y_n**") %>%
#   bold_p(t = .05) 
```






